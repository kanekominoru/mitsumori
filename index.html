<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>見積希望</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link href="https://cdn.jsdelivr.net/npm/pickerjs@1.2.1/dist/picker.min.css" rel="stylesheet">
  </head>
  <body>
    <form action="https://script.google.com/macros/s/AKfycbyLJibLUxEfNuwgN69IoFUGI5eEdr9Ne-QfyBihyUChf2nHV9drBFWswyTLl-obWDtCGA/exec" id="cc-form" method="post" class="w-75 mx-auto" target="sendMessage">
      <div>
      <div class="kintoneplugin-row">

        <input type="button" value="保険種目を追加" class="add pluralBtn">
        <input type="button" value="保険種目を削除" class="del pluralBtn">

        <p class="mt-3">見積を希望している保険種目をお教えください</p>
        <div>
            <select class="form-control w-100 mt-1" name="syumoku">
                <option selected>自動車</option>
                <option>火災</option>
                <option>生命保険</option>
                <option>その他</option>
            </select>
        </div>
        <p class="mt-3">※上記で生命保険を選んだ方は生命保険の種目を選択してください</p>
        <div>
            <select class="form-control w-100 mt-1" name="seiho">
                <option>-------</option>
                <option>医療保険</option>
                <option>がん保険</option>
                <option>生命保険</option>
            </select>
        </div>
        <p class="mt-3">希望する内容をお教えください</p>
        <div>
            <select class="form-control w-100 mt-1" name="kibonaiyo">
                <option>他代理店からの切替</option>
                <option>新規加入</option>
            </select>
        </div>
        <div id="data"></div> <!-- Added -->
        <p class="mt-3">※上記で他代理店からの切替を選んだ方は現在の保険証券を添付してください</p>
        <div class="input-group mb-3 fSub">
          <input type="file" class="form-control fFileAttach" id="inputGroupFile02" name="fFileAttach">
        </div>
      </div>
      </div>
      <button id="sendMessageTrigger" type="button" class="btn btn-primary">送信</button>
    </form>

    <iframe name="sendMessage"  style="display: none;"></iframe>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <!-- Added -->
    <script>
      const $form = $('#cc-form');
      const $trigger = $('#sendMessageTrigger');
      const $iframe = $('iframe[name="sendMessage"]');

      const liffId = "2007083053-YNDKlL8v";
      let userId = "";
      liff.init({liffId: liffId})
        .catch((err) => {
          console.log(err);
      });

      liff.ready.then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        }
        const idToken = liff.getDecodedIDToken();
        userId = idToken.sub;
        $('form').append(`<input type="hidden" name="userId" value="${userId}">`);
      });

      $(document).on("click", ".add", function() {
        let target = $(this).parent();
        if (target.parent().children().length < 4) {
          $(this).parent().clone(true).insertAfter($(this).parent());
          changeName();
        }
        
      });

      $(document).on("click", ".del", function() {
        let target = $(this).parent();
        if (target.parent().children().length > 1) {
          target.remove();
          changeName();
        }
        
      });

      $trigger.click(function() {
        
        $form.submit();

        // $form[0].reset();   // フォームをリセット

        return false;
      });

      $form.submit(function() {
        $iframe.unbind().bind('load', function() {
          // 結果が見たい場合はココで処理
          // sendText('text');
        });
      });

      $('.fFileAttach').on("change", function() {
          const file = this.files[0];
          const fr = new FileReader();
          fr.fileName = file.name;
          fr.onload = function(e) {
            html = '<input type="hidden" name="data" value="'+e.target.result.replace(/^.*,/, '')+'" >';
            html += '<input type="hidden" name="filename" value="'+e.target.fileName+'" >';
            html += '<input type="hidden" name="mimetype" value="' + e.target.result.match(/^.*(?=;)/)[0] + '" >';
            $("#data").empty().append(html); // Modified
          }
          fr.readAsDataURL(file);
      });

      const changeName = () => {
        let rowLen = document.querySelectorAll(".kintoneplugin-row").length;
        let bl = false;
        if (document.querySelector('input[name*="data"]')){
          bl = true;
        };
        for  (let i = 0; i < rowLen; i++) {
          $('select[name*="syumoku"]').eq(i).attr('name', 'syumoku' + String(i));
          $('select[name*="seiho"]').eq(i).attr('name', 'seiho' + String(i));
          $('select[name*="kibonaiyo"]').eq(i).attr('name', 'kibonaiyo' + String(i));

            $('input[name*="data"]').eq(i).attr('name', 'data' + String(i));
            $('input[name*="filename"]').eq(i).attr('name', 'filename' + String(i));
            $('input[name*="mimetype"]').eq(i).attr('name', 'mimetype' + String(i));

        }
      }

      const sendText = (text) => {
        liff.sendMessages([{
            'type': 'text',
            'text': text,
        }]).then(function () {
            liff.closeWindow();
        }).catch(function (error) {
            window.alert('Failed to send message ' + error);
        });
      }

    </script>

  </body>
</html>

